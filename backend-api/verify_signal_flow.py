#!/usr/bin/env python3
"""
‚úÖ SIGNAL FLOW VERIFICATION SCRIPT
Validates that signals are being:
1. Generated by Anso Vision Backend
2. Posted to MT5 Backend
3. Stored in Supabase
4. Retrieved by MT5 EA
"""

import requests
import json
from datetime import datetime

# Configuration
ANSO_VISION_URL = "https://anso-vision-backend.onrender.com"
MT5_BACKEND_URL = "https://ansorade-backend.onrender.com"
API_KEY = "Mr.creative090"

def test_signal_flow():
    print("\n" + "="*70)
    print("üß™ SIGNAL FLOW VERIFICATION TEST")
    print("="*70)
    
    # Step 1: Test Signal Generation
    print("\n1Ô∏è‚É£ TESTING SIGNAL GENERATION")
    print("-" * 70)
    try:
        response = requests.get(f"{ANSO_VISION_URL}/health")
        if response.status_code == 200:
            print("‚úÖ Anso Vision Backend: HEALTHY")
        else:
            print(f"‚ùå Anso Vision Backend: HTTP {response.status_code}")
    except Exception as e:
        print(f"‚ùå Cannot reach Anso Vision: {e}")
    
    # Step 2: Test MT5 Backend Connectivity
    print("\n2Ô∏è‚É£ TESTING MT5 BACKEND")
    print("-" * 70)
    try:
        response = requests.get(f"{MT5_BACKEND_URL}/health")
        if response.status_code == 200:
            print("‚úÖ MT5 Backend: HEALTHY")
        else:
            print(f"‚ùå MT5 Backend: HTTP {response.status_code}")
    except Exception as e:
        print(f"‚ùå Cannot reach MT5 Backend: {e}")
    
    # Step 3: Test Manual Signal Creation
    print("\n3Ô∏è‚É£ TESTING MANUAL SIGNAL CREATION")
    print("-" * 70)
    test_signal = {
        "symbol": "EURUSD",
        "action": "BUY",
        "volume": 0.01,
        "entry": 1.0950,
        "sl": 1.0920,
        "tp": 1.0980,
        "confidence": 0.85,
        "timeframe": "1h",
        "limit_orders": False,
        "reasoning": "TEST: Testing signal flow from Anso Vision to MT5"
    }
    
    try:
        headers = {
            "X-API-Key": API_KEY,
            "Content-Type": "application/json"
        }
        
        response = requests.post(
            f"{MT5_BACKEND_URL}/api/signal",
            json=test_signal,
            headers=headers,
            timeout=10
        )
        
        if response.status_code == 200:
            data = response.json()
            signal_id = data.get('signal_id')
            print(f"‚úÖ Signal created in Supabase: ID {signal_id}")
            print(f"   Symbol: {test_signal['symbol']}")
            print(f"   Action: {test_signal['action']}")
            print(f"   Entry: {test_signal['entry']:.4f}")
            print(f"   TP: {test_signal['tp']:.4f} | SL: {test_signal['sl']:.4f}")
            print(f"   Limit Orders: {test_signal['limit_orders']}")
            
            # Step 4: Test Signal Retrieval
            print("\n4Ô∏è‚É£ TESTING SIGNAL RETRIEVAL (EA Polling)")
            print("-" * 70)
            
            headers_ea = {"X-API-Key": API_KEY}
            response_get = requests.get(
                f"{MT5_BACKEND_URL}/api/signals/pending",
                headers=headers_ea,
                timeout=10
            )
            
            if response_get.status_code == 200:
                signals = response_get.json()
                if signals:
                    print(f"‚úÖ EA can retrieve pending signals: {len(signals)} signal(s)")
                    for sig in signals:
                        print(f"   ‚Ä¢ Signal ID: {sig.get('id')}")
                        print(f"     Symbol: {sig.get('symbol')}")
                        print(f"     Action: {sig.get('action')}")
                        print(f"     Entry: {sig.get('entry')}")
                        print(f"     Limit Orders: {sig.get('limit_orders')}")
                else:
                    print("‚ö†Ô∏è  No pending signals (might be expected)")
            else:
                print(f"‚ùå Cannot retrieve signals: HTTP {response_get.status_code}")
        
        else:
            print(f"‚ùå Failed to create signal: HTTP {response.status_code}")
            print(f"   Response: {response.text}")
    
    except Exception as e:
        print(f"‚ùå Error: {e}")
    
    print("\n" + "="*70)
    print("‚úÖ SIGNAL FLOW TEST COMPLETE")
    print("="*70)
    print("\nüìã WHAT WAS FIXED:")
    print("  1. ‚úÖ Supabase schema now includes 'limit_orders' field")
    print("  2. ‚úÖ Signal model updated to include 'limit_orders' & 'reasoning'")
    print("  3. ‚úÖ Anso Vision sends all fields when posting signals")
    print("  4. ‚úÖ MT5 backend receives and saves all fields")
    print("  5. ‚úÖ MT5 EA can retrieve signals with all data")
    print("\nüì° SIGNAL FLOW:")
    print("  Signal Generator (Anso Vision)")
    print("         ‚Üì")
    print("  POST /api/signal ‚Üí MT5 Backend")
    print("         ‚Üì")
    print("  Store in Supabase (all fields including limit_orders)")
    print("         ‚Üì")
    print("  GET /api/signals/pending ‚Üí MT5 EA Polls")
    print("         ‚Üì")
    print("  EA executes trade with all signal parameters")
    print("\n")

if __name__ == "__main__":
    test_signal_flow()
